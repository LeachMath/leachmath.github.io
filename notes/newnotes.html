<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CalcII Repository Browser</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
}

#container {
  display: flex;
  height: 100vh;
}

/* Sidebar */
#sidebar {
  width: 200px;
  border-right: 1px solid #ccc;
  overflow-y: auto;
  padding: 12px;
  background: #f5f5f5;
}

/* Viewer */
#viewer {
  flex: 1;
  height: 100%;
}

#viewerFrame {
  width: 100%;
  height: 100%;
  border: none;
}

.file {
  cursor: pointer;
  margin: 6px 0;
}

.file:hover {
  text-decoration: underline;
}

.dir {
  font-weight: bold;
}

#breadcrumb {
  font-size: 14px;
  margin-bottom: 10px;
}

/* Mobile layout */
@media (max-width: 700px) {
  #container {
    flex-direction: column;
  }

  #sidebar {
    width: 100%;
    height: 40vh;
    border-right: none;
    border-bottom: 1px solid #ccc;
  }

  #viewer {
    height: 60vh;
  }
}
</style>
</head>

<body>

<div id="container">
  <div id="sidebar">
    <h3>CalcII Files</h3>
    <div id="breadcrumb"></div>
    <div id="fileList">Loading...</div>
  </div>

  <div id="viewer">
    <iframe id="viewerFrame"></iframe>
  </div>
</div>

<script>
const owner = "LeachMath";
const repo = "CalcII";
const branch = "main";

const apiBase = `https://api.github.com/repos/${owner}/${repo}/contents`;
const cdnBase = `https://cdn.jsdelivr.net/gh/${owner}/${repo}@${branch}`;

// --------------------

async function loadPath(path = "") {
  const res = await fetch(apiBase + (path ? "/" + path : ""));
  const data = await res.json();

  renderBreadcrumb(path);
  renderList(data);
}

// --------------------

function renderBreadcrumb(path) {
  const bc = document.getElementById("breadcrumb");
  bc.innerHTML = "";

  const root = makeCrumb("root", "");
  bc.appendChild(root);

  if (!path) return;

  const parts = path.split("/");
  let running = "";

  parts.forEach(p => {
    bc.appendChild(document.createTextNode(" / "));
    running += (running ? "/" : "") + p;
    bc.appendChild(makeCrumb(p, running));
  });
}

function makeCrumb(name, path) {
  const span = document.createElement("span");
  span.textContent = name;
  span.className = "file";
  span.onclick = () => loadPath(path);
  return span;
}

// --------------------

function renderList(items) {
  const list = document.getElementById("fileList");
  list.innerHTML = "";

  items.sort((a,b) => (a.type === "dir" ? -1 : 1));

  items.forEach(item => {
    const div = document.createElement("div");
    div.className = "file";

    if (item.type === "dir") {
      div.textContent = "ðŸ“ " + item.name;
      div.classList.add("dir");
      div.onclick = () => loadPath(item.path);
    } else {
      div.textContent = "ðŸ“„ " + item.name;
      div.onclick = () => openFile(item.path);
    }

    list.appendChild(div);
  });
}

// --------------------

function openFile(path) {
  const url = cdnBase + "/" + path;
  const frame = document.getElementById("viewerFrame");
  const lower = path.toLowerCase();

  // ---- PDF.js viewer (best mobile behavior) ----
  if (lower.endsWith(".pdf")) {
    const viewer = "https://mozilla.github.io/pdf.js/web/viewer.html?file=";
    frame.src = viewer + encodeURIComponent(url);
    return;
  }

  // ---- Images ----
  if (lower.match(/\.(png|jpg|jpeg|gif|webp|svg)$/)) {
    frame.srcdoc = `<img src="${url}" style="max-width:100%">`;
    return;
  }

  // ---- Markdown ----
  if (lower.endsWith(".md")) {
    fetch(url)
      .then(r => r.text())
      .then(t => {
        frame.srcdoc = "<pre style='padding:20px'>" +
          t.replace(/</g,"&lt;") +
          "</pre>";
      });
    return;
  }

  // ---- Text files ----
  if (lower.match(/\.(txt|csv|tex)$/)) {
    fetch(url)
      .then(r => r.text())
      .then(t => {
        frame.srcdoc = "<pre style='padding:20px'>" +
          t.replace(/</g,"&lt;") +
          "</pre>";
      });
    return;
  }

  // ---- HTML or other ----
  frame.src = url;
}

// --------------------

loadPath();
</script>

</body>
</html>
